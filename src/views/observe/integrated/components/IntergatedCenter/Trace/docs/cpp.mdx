import Alert from '@/views/observe/integrated/components/IntergatedCenter/Alert';

<Alert message="在使用前请联系集群管理员开启 KubeGems Observability 相关的组件。" />

## KubeGems OpenTelemetry Collector

修改应用 SDK 中的 Exporter Endpoint 地址为 opentelemetry-collector.observability: `<port>`。 其中， opentelemetry-collector 是 Collector 的 Service 名称，observability 是 Collector 所在命名空间，不同上报协议对应端口如下:

| Receivers |  Protocols  | Port  |
| :-------: | :---------: | :---: |
|   otlp    |    gRPC     | 4317  |
|   otlp    |    http     | 4318  |
|  jaeger   |    gRPC     | 14250 |
|  jaeger   | thrift_http | 14268 |
|  zipkin   |             | 9411  |

## C++ 接入

OpenTelemetry C++ SDK 提供了 OpenTelemetry C++ API 的参考实现，并根据规范为处理器、采样器和核心导出器提供实现。

## 配置 exporter

导出器负责将遥测数据发送到特定的后端。OpenTelemetry 提供了六个开箱即用的跟踪导出器：

- In-Memory Exporter：将数据保存在内存中，用于调试。
- Jaeger Exporter：准备收集的遥测数据并将其通过 UDP 和 HTTP 发送到 Jaeger 后端。
- Zipkin 导出器：准备收集的遥测数据并将其通过 Zipkin API 发送到 Zipkin 后端。
- Logging Exporter：将遥测数据保存到日志流中。
- OpenTelemetry(otlp) Exporter：使用 protobuf/gRPC 或 protobuf/HTTP 将数据发送到 OpenTelemetry Collector。
- ETW 导出器：将遥测数据发送到 Windows 事件跟踪 (ETW)。

```cpp
//namespace alias used in sample code here.
namespace sdktrace   = opentelemetry::sdk::trace;
// otlp grpc exporter
opentelemetry::exporter::otlp::OtlpGrpcExporterOptions opts;
opts.endpoint = "opentelemetry-collector.observability::4317";
opts.use_ssl_credentials = false;
opts.ssl_credentials_cacert_as_string = "ssl-certificate";
auto otlp_grpc_exporter =
    std::unique_ptr<sdktrace::SpanExporter>(new opentelemetry::exporter::otlp::OtlpGrpcExporter(opts));

// otlp http exporter
opentelemetry::exporter::otlp::OtlpHttpExporterOptions opts;
opts.url = "http://opentelemetry-collector.observability:4318/v1/traces";
auto otlp_http_exporter =
    std::unique_ptr<sdktrace::SpanExporter>(new opentelemetry::exporter::otlp::OtlpHttpExporter(opts));
```

## 配置资源

```cpp
auto resource_attributes = opentelemetry::sdk::resource::ResourceAttributes
    {
        {"service.name", "shoppingcart"},
        {"service.instance.id", "instance-12"}
    };
auto resource = opentelemetry::sdk::resource::Resource::Create(resource_attributes);
auto received_attributes = resource.GetAttributes();
```

## 配置 trace 采样

```cpp
//AlwaysOnSampler
auto always_on_sampler = std::unique_ptr<sdktrace::AlwaysOnSampler>
    (new sdktrace::AlwaysOnSampler);

//AlwaysOffSampler
auto always_off_sampler = std::unique_ptr<sdktrace::AlwaysOffSampler>
    (new sdktrace::AlwaysOffSampler);

//ParentBasedSampler
auto parent_based_sampler = std::unique_ptr<sdktrace::ParentBasedSampler>
    (new sdktrace::ParentBasedSampler);

//TraceIdRatioBasedSampler - Sample 50% generated spans
double ratio       = 0.5;
auto always_off_sampler = std::unique_ptr<sdktrace::TraceIdRatioBasedSampler>
    (new sdktrace::TraceIdRatioBasedSampler(ratio));
```

## 更多设置

请参考 [OpenTelemetry C++ SDK](https://opentelemetry-cpp.readthedocs.io/en/latest/sdk/GettingStarted.html)
